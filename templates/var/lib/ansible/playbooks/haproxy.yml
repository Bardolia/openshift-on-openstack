{{=<% %>=}}
- include: /usr/share/ansible/openshift-ansible/playbooks/common/openshift-cluster/evaluate_groups.yml
  vars:
    g_etcd_hosts:   "{{ groups.etcd | default([]) }}"
    g_lb_hosts:     "{{ groups.lb | default([]) }}"
    g_master_hosts: "{{ groups.masters | default([]) }}"
    g_node_hosts:   "{{ groups.nodes | default([]) }}"
    g_new_node_hosts: "{{ groups.new_nodes | default([]) }}"
    g_nfs_hosts:   "{{ groups.nfs | default([]) }}"
    g_all_hosts:    "{{ g_master_hosts | union(g_node_hosts) | union(g_etcd_hosts)
                        | union(g_lb_hosts) | default([]) }}"

- name: Gather facts
  hosts: masters
  roles:
    - { role: 'openshift_facts'}


- name: Configure load balancers
  hosts: oo_lb_to_config
  vars:
    os_firewall_use_firewalld: false
    os_firewall_allow:
    - service: router http
      port: "80/tcp"
    - service: router https
      port: "443/tcp"
  roles:
  - role: os_firewall
  - role: openshift_facts
  tasks:
    - set_fact:
        servers: "{{ hostvars | oo_select_keys(groups['oo_masters']) }}"
    - name: Configure haproxy
      template:
        src: /var/lib/ansible/templates/etc/haproxy/router.cfg.j2
        dest: /etc/haproxy/router.cfg
        owner: root
        group: root
        mode: 0644
    - name: Include config file
      replace: dest=/etc/sysconfig/haproxy regexp='OPTIONS=.*' replace='OPTIONS="-f /etc/haproxy/router.cfg"'
    - name: Enable and start haproxy
      service:
        name: haproxy
        state: restarted
        enabled: yes
      register: start_result
<%={{ }}=%>
